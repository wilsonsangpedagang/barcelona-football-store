<!-- Modal -->
<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-black bg-opacity-60">
  <div id="crudModalContent" class="bg-[#004D98] text-white rounded-2xl shadow-2xl w-11/12 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto border-4 border-[#EDBB00]">
    <!-- Modal header -->
    <div class="flex items-center justify-between px-6 py-4 border-b-2 border-[#EDBB00] bg-[#A50044] rounded-t-xl">
      <div>
        <h3 class="text-2xl font-bold text-white">Create New Product</h3>
        <p class="text-sm text-[#EDBB00]">Add a new product to the Barcelona Football Store</p>
      </div>
      <button type="button" class="text-[#EDBB00] hover:text-white hover:bg-[#EDBB00]/30 rounded-lg p-2 transition" onclick="hideModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>

    <!-- Modal body -->
    <div class="px-6 py-6 space-y-5">
      <form id="productForm" class="space-y-5">
        {% csrf_token %}
        <div>
          <label for="name" class="block text-sm font-semibold text-[#EDBB00]">Product Name</label>
          <input type="text" id="name" name="name" 
            class="mt-1 w-full rounded-md border-2 border-[#EDBB00] bg-[#002E6D] text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#EDBB00]"
            placeholder="Enter product name" required>
        </div>

        <div>
          <label for="price" class="block text-sm font-semibold text-[#EDBB00]">Price (â‚¬)</label>
          <input type="number" id="price" name="price" min="0" step="0.01"
            class="mt-1 w-full rounded-md border-2 border-[#EDBB00] bg-[#002E6D] text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#EDBB00]"
            placeholder="Enter product price" required>
        </div>

        <div>
          <label for="description" class="block text-sm font-semibold text-[#EDBB00]">Description</label>
          <textarea id="description" name="description" rows="3"
            class="mt-1 w-full rounded-md border-2 border-[#EDBB00] bg-[#002E6D] text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#EDBB00]"
            placeholder="Enter product description" required></textarea>
        </div>

        <div>
          <label for="category" class="block text-sm font-semibold text-[#EDBB00]">Category</label>
          <select id="category" name="category" 
            class="mt-1 w-full rounded-md border-2 border-[#EDBB00] bg-[#002E6D] text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#EDBB00]" 
            required>
            <option value="">Select a category</option>
            <option value="jersey">Jersey</option>
            <option value="equipment">Equipment</option>
            <option value="merchandise">Merchandise</option>
            <option value="accessories">Accessories</option>
            <option value="collectibles">Collectibles</option>
          </select>
        </div>

        <div>
          <label for="thumbnail" class="block text-sm font-semibold text-[#EDBB00]">Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail"
            class="mt-1 w-full rounded-md border-2 border-[#EDBB00] bg-[#002E6D] text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#EDBB00]"
            placeholder="https://example.com/product-image.jpg">
        </div>

        <div class="flex items-center">
          <input id="is_featured" name="is_featured" type="checkbox" 
            class="w-4 h-4 text-[#EDBB00] bg-[#002E6D] border-[#EDBB00] rounded focus:ring-[#EDBB00] focus:ring-2">
          <label for="is_featured" class="ml-2 text-sm font-medium text-white">Featured Product</label>
        </div>
      </form>
    </div>

    <!-- Modal footer -->
    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t-2 border-[#EDBB00] bg-[#A50044]/80 rounded-b-xl">
      <button type="button" 
        id="cancelButton"
        class="order-2 sm:order-1 w-full sm:w-auto px-6 py-3 rounded-md font-semibold bg-[#EDBB00] text-[#004D98] hover:bg-[#FFD700] transition"
        onclick="hideModal()">Cancel</button>
      
      <button type="submit" 
        id="submitProduct" 
        form="productForm"
        class="order-1 sm:order-2 w-full sm:w-auto px-6 py-3 rounded-md font-semibold bg-[#004D98] text-white border-2 border-[#EDBB00] hover:bg-[#003974] transition">
        Publish Product</button>
    </div>
  </div>
</div>



<script>
let currentEditId = null;

// Show modal for creating a new product
function showModal() {
    currentEditId = null;
    document.querySelector('#crudModal h3').textContent = "Create New Product";
    document.querySelector('#crudModal p').textContent = "Add a new product to the Barcelona Football Store";
    document.querySelector('#submitProduct').textContent = "Publish Product";
    
    document.querySelector('#productForm').reset();
    document.getElementById('crudModal').classList.remove('hidden');
}

// Show modal for editing an existing product
function showEditModal(product) {
    currentEditId = product.id;
    document.querySelector('#crudModal h3').textContent = "Edit Product";
    document.querySelector('#crudModal p').textContent = "Update the product details";
    document.querySelector('#submitProduct').textContent = "Update Product";

    // Fill in existing data
    document.getElementById('name').value = product.name;
    document.getElementById('price').value = product.price;
    document.getElementById('description').value = product.description;
    document.getElementById('category').value = product.category;
    document.getElementById('thumbnail').value = product.thumbnail;
    document.getElementById('is_featured').checked = product.is_featured;

    document.getElementById('crudModal').classList.remove('hidden');
}

// Hide modal
function hideModal() {
    document.getElementById('crudModal').classList.add('hidden');
    document.querySelector('#productForm').reset();
}

// Add new product
async function addProduct(event) {
    event.preventDefault();
    
    try {
        const response = await fetch("{% url 'main:add_product_ajax' %}", {
            method: "POST",
            body: new FormData(document.querySelector('#productForm'))
        });

        if (response.ok) {
            // Reset form and hide modal
            document.getElementById("productForm").reset();
            hideModal();
            
            // Show success notification
            showProductCreatedToast();

            // Notify main.html about new data
            document.dispatchEvent(new CustomEvent('productAdded'));
        } else {
            const data = await response.json();
            showToast(data.message || 'Failed to add product', '', 'error');
        }
    } catch (error) {
        console.error("Error adding product:", error);
        showToast('An unexpected error occurred', '', 'error');
    }

    return false;
}


// Edit existing product
async function editProduct(event) {
    event.preventDefault();
    if (!currentEditId) return;

    const form = document.querySelector('#productForm');
    const formData = new FormData(form);

    try {
        const response = await fetch(`{% url 'main:edit_product_ajax' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', currentEditId), {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });

        const data = await response.json();
        
        if (response.ok) {
            hideModal();
            showProductUpdatedToast();
            // Refresh the product list
            if (typeof refreshProducts === 'function') {
                refreshProducts();
            }
        } else {
            showToast(data.message || "Failed to update product", "error");
        }
    } catch (error) {
        console.error("Error updating product:", error);
        showToast("An unexpected error occurred", "error");
    }
}

// Initialize form submission handling
document.querySelector('#productForm').addEventListener('submit', function(event) {
    event.preventDefault();
    if (currentEditId) {
        editProduct(event);
    } else {
        addProduct(event);
    }
});

// Initialize modal close on backdrop click
document.querySelector('#crudModal').addEventListener('click', function(event) {
    if (event.target === this) {
        hideModal();
    }
});
</script>